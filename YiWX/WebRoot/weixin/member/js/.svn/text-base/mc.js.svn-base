var _appVersion=1;var _ua=navigator.userAgent,_touchSupport=("createTouch" in document),_hashSupport=!!("onhashchange" in window),_clkEvtType=_touchSupport?"touchstart":"click",_movestartEvt=_touchSupport?"touchstart":"mousedown",_moveEvt=_touchSupport?"touchmove":"mousemove",_moveendEvt=_touchSupport?"touchend":"mouseup",_isIOS=(_ua.match(/iPhone|iPad|iPod/i)?true:false),_isMeizu=/M030|M031|M032|MEIZU/.test(navigator.userAgent),_isOldIOS=/OS\s[1-4]_[0-4]/.test(_ua),_isAndroid=(/Android\s/.test(_ua)||_isMeizu),_isOldAndroid22=/Android\s[1-2]\.[0-2]/.test(_ua),_isOldAndroid23=/Android\s[1-2]\.[0-3]/.test(_ua),_vendor=(/webkit/i).test(navigator.appVersion)?"webkit":(/firefox/i).test(navigator.userAgent)?"Moz":"opera" in window?"O":(/MSIE/i).test(navigator.userAgent)?"ms":"",_has3d="WebKitCSSMatrix" in window&&"m11" in new WebKitCSSMatrix(),_trnOpen="translate"+(_has3d?"3d(":"("),_trnClose=_has3d?",0)":")",_needHistory=(_isIOS&&!!(window.history&&window.history.pushState)),_appCache=window.applicationCache,sign,_isMember,_q=function(b){return document.querySelector(b)},_qAll=function(b){return document.querySelectorAll(b)};function _checkOffline(){var b=!!_appCache;if(!b){return}_appCache.addEventListener("progress",function(d){try{_appCache.swapCache()}catch(a){}});_appCache.addEventListener("updateready",function(d){if(_appCache.status==_appCache.UPDATEREADY){try{_appCache.swapCache()}catch(a){}location.href=location.origin+location.pathname+"?rnd="+Math.random()+location.hash}},false)}_checkOffline();function _removeClass(i,j){var e=new RegExp("(^|\\s)+("+j+")(\\s|$)+","g");try{i.className=i.className.replace(e,"$1$3")}catch(g){}e=null}function _addClass(c,d){_removeClass(c,d);c.className=c.className+" "+d}function _forEach(d,c){Array.prototype.forEach.call(d,c)}function _show(){var k=0,g=arguments.length,j;for(;k<g;k++){j=arguments[k];if(j.nodeType!=undefined&&j.nodeType==1){j.style.display=""}else{if(j.hasOwnProperty("length")){try{var i=[];_forEach(j,function(b,c,a){i.push(b)});_show.apply(null,i)}catch(l){}}}}}function _hide(){var k=0,g=arguments.length,j;for(;k<g;k++){j=arguments[k];if(j&&j.nodeType!=undefined&&j.nodeType==1){j.style.display="none"}else{if(j&&j.hasOwnProperty("length")){try{var i=[];_forEach(j,function(b,c,a){i.push(b)});_hide.apply(null,i)}catch(l){}}}}}function _isImageOk(b){if(!b.complete){return false}if(typeof b.naturalWidth!="undefined"&&b.naturalWidth==0){return false}return true}function _registImgLoad(d,c){if(_isImageOk(d)){c.call(null)}else{d.addEventListener("load",c);d.src=d.src}}function _alterImgSize(s,o){try{var n=o.width,r=o.height,t=s.width,m=s.height,u=1,v=function(b,c,a,d){if(c<=1){return}b.style.width=p(a)+"px";b.style.height=p(d)+"px"},p=function(a){return Math.round(a)};u=t/n;v(s,u,t/u,m/u);u=m/r;v(s,u,t/u,m/u)}catch(q){}}var MCache=(function(){var b={};return{set:function(a,d){b[a]=d},get:function(a){return b[a]},clear:function(){b={}},remove:function(a){delete b[a]}}}());var MStorage=(function(){var m=window.sessionStorage,l=window.localStorage,o=function(a){if(a in m){return JSON.parse(m[a])}else{if(a in l){return JSON.parse(l[a])}else{return null}}},k=function(a,b){b=JSON.stringify(b);m[a]=b;l[a]=b},p=function(a){m.removeItem(a);l.removeItem(a)},n=function(){m.clear();l.clear()},j=function(a){var b,d,c=0;for(;c<l.length;c++){b=l.key(c);d=l.getItem(b);if(d.ts<((new Date())-a)){l.removeItem(b)}}};return{get:o,set:k,remove:p,clear:n,checkExpires:j}}());var MData=(function(){function g(a){return a.replace(/([A-Z])/g,"-$1").toLowerCase()}function d(a,b,c){a.setAttribute("data-"+g(b),c)}function e(a,b){var c=a.getAttribute("data-"+g(b));return c||undefined}return function(a,c,j){if(arguments.length>2){try{a.dataset[c]=j}catch(b){d(a,c,j)}}else{try{return a.dataset[c]}catch(b){return e(a,c)}}}}());var MBrowser=(function(){var c=navigator.userAgent.toLowerCase();var d={version:(c.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/i.test(c)&&!this.chrome,opera:/opera/i.test(c),firefox:/firefox/i.test(c),ie:/msie/i.test(c)&&!/opera/.test(c),mozilla:/mozilla/i.test(c)&&!/(compatible|webkit)/.test(c)&&!this.chrome,chrome:/chrome/i.test(c)&&/webkit/i.test(c)&&/mozilla/i.test(c)};return d}());var MURLHash=(function(){function g(c,b){var n=encodeURIComponent,o,k=[];var a=b?b:"&";for(o in c){k.push(n(o)+"="+n(c[o]))}return k.join(a)}function e(b,a){var c=b.indexOf(a);return c==-1?[b,""]:[b.substring(0,c),b.substring(c+1)]}var d=function(y,i,u){var s=y||window.location.href;var z=u||"&";var a=e(s,i||"#");var o=a[0];var b=a[1];this.map={};this.sign=z;if(b){var v=b.split(z);for(var w=0;w<v.length;w++){var c=v[w];var x=e(c,"=");this.map[x[0]]=x[1]}}this.size=function(){return this.keys().length};this.keys=function(){var k=[];for(var j in this.map){if(j!="_hashfoo_"){k.push(j)}}return k};this.values=function(){var k=[];for(var j in this.map){if(j!="_hashfoo_"){k.push(this.map[j])}}return k};this.put("_hashfoo_",Math.random())};d.prototype.get=function(a){return this.map[a]||null};d.prototype.put=function(b,a){this.map[b]=a};d.prototype.set=d.prototype.put;d.prototype.putAll=function(b){if(typeof(b)=="object"){for(var a in b){this.map[a]=b[a]}}};d.prototype.remove=function(b){if(this.map[b]){var c={};for(var a in this.map){if(a!=b){c[a]=this.map[a]}}this.map=c}};d.prototype.toString=function(){var a={};for(var b in this.map){if(b!="_hashfoo_"){a[b]=this.map[b]}}return g(a,"&")};d.prototype.clone=function(){return new d("foo#"+this.toString(),this.sign)};return d}());function _upShowConfirm(u,o,m,q,r,s,n){var v=document.createDocumentFragment(),p=document.createElement("div"),t=document.createElement("div");t.className="modal";t.id="modal_"+u;v.appendChild(t);p.className="popup";p.id=u;p.innerHTML='<div class="pinner"><a href="javascript:void(0)" class="pclose">┿</a><p class="title">'+o+'</p><p class="cont">'+m+'</p><a href="javascript:void(0)" class="cancel">'+(s||"取消")+'</a><a href="javascript:void(0)" class="ok">'+(q||"确定")+"</a></div>";v.appendChild(p);document.body.appendChild(v);if(_isOldAndroid22||_isOldAndroid23||_isOldIOS||_isMeizu){t.style.position="absolute";p.style.position="absolute"}_q("#"+u+" .pclose").addEventListener("click",_upCloseConfirm);if(r){_q("#"+u+" .ok").addEventListener("click",r)}else{_q("#"+u+" .ok").addEventListener("click",_upCloseConfirm)}if(n){_q("#"+u+" .cancel").addEventListener("click",n)}else{_q("#"+u+" .cancel").addEventListener("click",_upCloseConfirm)}_q("html").style["overflow-y"]="hidden"}function _upCloseConfirm(g){var i,j;if(typeof g=="string"){i="modal_"+g}else{i=g.target.parentNode.parentNode.id}_q("html").style["overflow-y"]="";try{document.body.removeChild(_q("#"+i));document.body.removeChild(_q("#modal_"+i))}catch(e){}}function _fixFootBtnForOldIOS(m){var k=_q(".footFix"),n=window.innerHeight,i=window.scrollY,j;if(k){try{j=k.clientHeight;k.style.position="absolute";k.style.top=i+n-j+"px"}catch(l){}}}function _flipCard(d){if(d.target.tagName&&d.target.tagName.toLowerCase()=="a"&&d.target.className=="autotel"){return}var e=_q(".card"),g=MData(e,"side");if(!g){g=1}if(g==1){_addClass(e,"flip")}else{_removeClass(e,"flip")}g*=-1;MData(e,"side",g)}var console=window.console||{log:function(){}};function _html5FixForOldEnv(){var b="abbr,article,aside,audio,canvas,datalist,details,dialog,eventsource,figure,figcaption,footer,header,hgroup,mark,menu,meter,nav,output,progress,section,small,time,video";b.split(",").forEach(function(e,g,a){document.createElement(e)});_writeCSS(b+"{display:block;}")}function _writeCSS(d){var g=document.createElement("style");try{g.innerHTML=d}catch(e){g.innerText=d}try{_q("head").appendChild(g)}catch(e){}}_html5FixForOldEnv();var WAPP=(function(A){var w=null,C=[],E=false,u,F,x,H,I={},t="",J={ajax:function(b,c,g){if(E){return}if(g==undefined){g=true}var l=b.url,m=b.method,j=b.params,a=b.callback,i,d=[];if(A.ActiveXObject){i=new ActiveXObject("Microsoft.XMLHTTP")}else{if(A.XMLHttpRequest){i=new XMLHttpRequest()}else{return false}}i.onreadystatechange=function(){if(i.readyState==4){if(i.status==200||i.status==0){E=false;var o=JSON.parse(i.responseText);if(!o){throw"[ajax] result error"}if(o.result.hasOwnProperty("appVersion")&&o.result.appVersion*1!==_appVersion){console.log("force reload, waiting for update");A.setTimeout(function(){try{_appCache.swapCache()}catch(p){}location.href=location.origin+location.pathname+"?rnd="+Math.random()+location.hash},6180);return}if(a){a.call(b,o)}if(g){if(o.hasOwnProperty("code")){o.issuccess=(o.code*1==0)}if(o.hasOwnProperty("result")){for(var n in o.result){o[n]=o.result[n]}o.result=null;if(o.hasOwnProperty("cardType")){o.cardType=o.cardType*1}if(o.hasOwnProperty("ismember")){o.ismember=o.ismember*1}if(!o.hasOwnProperty("alertWhenError")){o.alertWhenError=1}o.alertWhenError=o.alertWhenError*1}}if(c){c.call(null,o)}if(w.callback_loadingOff){w.callback_loadingOff.call(null)}}}};if(!m){m="post"}m=m.toLowerCase();if(j){for(var k in j){d.push(k+"="+j[k])}}d.push("majaxr="+Math.random());d=d.join("&");if(!d.length){d=null}if(m=="get"&&d!=null){if(l.indexOf("?")>-1){l+="&"}else{l+="?"}l+=d;d=null}console.log("[ajax]: ",j,l,d);try{i.open(m,l,true);if(m=="post"){i.setRequestHeader("content-type","application/x-www-form-urlencoded")}i.send(d);E=true;if(w.callback_loadingOn){w.callback_loadingOn.call(null)}}catch(e){throw"ajax fail";E=false;if(w.callback_loadingOff){w.callback_loadingOff.call(null)}}return true},parseTmpl:function(d,i){var e=d,b,a,g,j,k,c;b=new RegExp("{\\$\\$\\$([^$]+)\\$\\$\\$}","g");k=e.match(b);if(k!=null){for(g=0;g<k.length;g++){c=k[g].replace(/^\{\${3}/,"").replace(/\${3}\}$/,"");if(v.hasOwnProperty(c)){e=e.replace(k[g],v[c])}else{e=e.replace(k[g],"")}}}b=/\{\#{3}[^\#]+\#{3}\}/g;k=e.match(b);if(k!=null){for(g=0;g<k.length;g++){c=k[g].replace(/^\{\#{3}/,"").replace(/\#{3}\}$/,"");if(c.indexOf(".")>-1){var l=c.split(".");a=i[l[0]];if(a!==undefined){for(j=1;j<l.length;j++){if(a&&a.hasOwnProperty(l[j])){a=a[l[j]]}else{a=k[g]}}}}else{if(i.hasOwnProperty(c)&&typeof i[c]==="string"&&!i[c].length){a=""}else{a=i[c]||k[g]}}e=e.replace(k[g],a)}}return e},clearStage:function(){F.id="";F.className="";x.innerHTML="";J.fixBtnHook(false);J.cardFlipHook(false);_forEach(C,function(a,b,c){a.obj.removeEventListener(a.type,a.func)});C=[];if(w.callback_loadingOff){w.callback_loadingOff.call(null)}},addToStage:function(a){F.id="";F.className="";x.innerHTML=a;J.fixBtnHook(true);J.cardFlipHook(true)},listenEvt:function(a,c,b){a.addEventListener(c,b);C.push({obj:a,type:c,func:b})},fixBtnHook:function(a){if(_q("#footBtn")||_q(".footFix")){if(a==undefined){a=true}if(_isOldIOS||_isOldAndroid22||_isMeizu){if(_isOldAndroid22||_isMeizu){if(a){u=A.setInterval(_fixFootBtnForOldIOS,500)}else{A.clearInterval(u)}}else{if(a){u=A.setTimeout(_fixFootBtnForOldIOS,200);A.addEventListener("scroll",_fixFootBtnForOldIOS);A.addEventListener("resize",_fixFootBtnForOldIOS);A.addEventListener("touchmove",_fixFootBtnForOldIOS);A.addEventListener("touchend",_fixFootBtnForOldIOS)}else{A.clearTimeout(u);A.removeEventListener("scroll",_fixFootBtnForOldIOS);A.removeEventListener("resize",_fixFootBtnForOldIOS);A.removeEventListener("touchmove",_fixFootBtnForOldIOS);A.removeEventListener("touchend",_fixFootBtnForOldIOS)}}}}},cardFlipHook:function(a){var b=_q(".card");if(!b){return}if(a==undefined){a=true}if(a){if(_isOldAndroid23){_addClass(b,"old")}b.addEventListener(_clkEvtType,_flipCard)}else{b.removeEventListener(_clkEvtType,_flipCard)}},drawCardReturnTag:function(){var a=_q("#card_ctn .backtag canvas"),c=a.getContext("2d"),b=MData(a,"bgcolor");a.width=54;a.height=30;c.lineJoin="miter";c.lineCap="butt";c.fillStyle=b;c.moveTo(2,0);c.lineTo(54,0);c.lineTo(54,15);c.lineTo(27,24);c.lineTo(2,15);c.lineTo(2,2);c.lineTo(0,2);c.lineTo(2,0);c.closePath();c.fill()},pageChg:function(){if(w.onPageChange){w.onPageChange.call(null,t)}_q("body").scrollTop=0},setCurrPage:function(a){t=a;console.log("setCurrPage",a)},updateHash:function(a){var b=new MURLHash("foo#"),c,d;for(d in a){b.put(d,a[d])}c=b.toString();location.hash=c;console.log("updateHash",c)},directJumpInIOSWeixin:function(e){var a=location.href.replace(/#.*$/,"").replace(/\??ioswx\=[\d|\.]+/,""),c="&",d=[];if(a.indexOf("?")==-1){c="?"}for(var b in e){d.push(b+"="+e[b])}a=a+c+"ioswx="+Math.random()+"#"+d.join("&");a=a.replace(/\?+/,"?").replace(/\&+/,"&").replace(/\#+/,"#");location.href=a;console.log("directJumpInIOSWeixin",a)},bindHashListener:function(){if(!_hashSupport){A.addEventListener("hashchange",B.hashchgEvt)}else{if(!A.hasOwnProperty("_oldurlflag")){A._oldurlflag=location.href}A.setInterval(function(){var a=location.href;if(a==A._oldurlflag){return}console.log("fake hash",a);B.hashchgEvt.call(null,{newURL:a,oldURL:A._oldurlflag});A._oldurlflag=a},500)}},unbindHashListener:function(){A.removeEventListener("hashchange",B.hashchgEvt)},parseRoundUL:function(){var a=_qAll("ul.round");if(!a.length){return}_forEach(a,function(b,d,e){var c=b.getElementsByTagName("li");_forEach(c,function(j,g,i){if(c.length==1){_addClass(j,"only")}else{if(g==0){_addClass(j,"first")}else{if(g==c.length-1){_addClass(j,"last")}}}})})},confirmTel:function(){var a=_qAll(".autotel");if(!a.length){return}function b(c){c.preventDefault();var d=c.currentTarget;if(A.confirm("是否拨打 "+MData(d,"telnum").replace("tel:","")+" ?")){location.href=MData(d,"telnum")}}_forEach(a,function(c,d,e){MData(c,"telnum",c.href);c.href="javascript:void(0)";J.listenEvt(c,"click",b)})}},B={hashchgEvt:function(c){var b=new MURLHash(c.newURL),d=new MURLHash(c.oldURL),e=b.get("act")*1,a=d.get("act")*1;console.log("hashchange","from "+a+" to "+e);z.RouteCommand()},commonAjaxClick:function(b){var a=b.currentTarget,e={act:MData(a,"ajaxAct")},c,d;if(MData(a,"ajaxParams")){c=MData(a,"ajaxParams");c=JSON.parse(c);for(d in c){e[d]=c[d]}}if(_isIOS){J.directJumpInIOSWeixin(e)}else{J.updateHash(e)}}},G={ReqObject:function(d,a,c,b,e){this.url=d;this.method=a;this.params=c;this.callback=b;this.set=function(g,i){if(!e||(e&&!this.params.hasOwnProperty(g))){this.params[g]=i}}}},v={flipcardTmpl:' <div class="card"><div class="front"><figure class="fg" style="background-image:url({###cardfrontimg###});"> <img id="cardlogoimg" src="{###cardlogoimg###}" /><img data-src="{###barcodeimg###}" style="display:none;" /><figcaption class="fc"> <span class="cname" style="color:{###cardcolor0###};">{###cardname###}</span> <span class="t" style="color:{###cardcolor1###};text-shadow:{###cardshadow1###} 0 -1px;">{###shopname###}</span><span class="n" style="display:none;color:{###cardcolor2###};text-shadow:{###cardshadow2###} 0 -1px;">{###cardNum###}</span> </figcaption> </figure> </div> <div class="back"> <figure class="fg" style="background-image:url({###cardbackimg###});"><div class="backtag"><canvas data-bgcolor="{###cardreturnbg###}"></canvas><p style="color:{###cardreturnclr###}">{###cardreturntxt###}</p></div><div class="info"> <p class="addr">{###shopaddr###}</p> <p class="tel"><a class="autotel" href="tel:{###shoptel###}">{###shoptel###}</a></p> </div> <p class="keywords">{###keywords###}</p> </figure></div></div>',memberCardTmpl:['<section id="card_ctn"><div class="bk1"></div><div class="cont">',"{$$$flipcardTmpl$$$}","</div></section>",'<div id="guest" style="display:none;"> <small><em>{###powerNotice###}</em></small> <ul class="round"> </ul><div class="footFix" id="footBtn"> <a href="javascript:void(0)">{###getcardBtn###}</a> </div> </div>  <div id="vip" style="display:none;"> <small><em>{###powerNotice###}</em></small> <ul class="round"> </ul> </div>'].join(""),shopCardTmpl:['<section class="cc_shop" id="card_ctn"><div class="bk1"></div><div class="cont">',"{$$$flipcardTmpl$$$}",'<div class="vs1" style="display:none;"> <span class="c">{###cardcount###}</span><h1>{###desc1###}</h1> </div>  <div class="vs2" style="display:none;"> <h1>{###desc2###}</h1></div>',"</div></section>",'<div class="vs1" style="display:none;"> <ul id="shop_icons"> </ul>  <div class="footFix" id="footBtn"> ','<a href="javascript:void(0)">{###getcardBtn###}</a> </div> </div>  <div class="vs2" id="shop_lst" style="display:none;"> </div>  <footer style="height:20px;"></footer>'].join(""),shopLstTmpl:'<h1>{###title###}</h1> <div class="lst"> <ul> </ul> </div>',powerIsOverTmpl:'<h1 id="poNotice">{###powerIsOver.notice###}</h1><a id="poBtn" href="{###powerIsOver.link###}"><span>{###powerIsOver.label###}</span></a>',powerTmpl:['<header class="use_hd"> <div class="hinn box"> <div class="inner"> <img src="{###circlelogo###}" /> <h1>{###detail###}</h1>',' <time datetime="{###datetime###}">{###datelabel###}{###datetime###}</time><span class="count">{###maxCount###}</span></div> <a class="detail" style="display:none;" href="javascript:void(0)">{###detaillabel###}</a> </div>','</header>  <aside class="use_note asd1 inner"></aside> ','<div class="footFix" id="pwr_footFrm" style="display:none;"> <div class="inner"> <input type="text" placeholder="{###reverseIptNote###}" /> <input type="submit" value="{###reverseBtnTxt###}" /> </div> </div>','<div class="pw_xflip" id="use_code" style="display:none;"> <div class="back"><div class="ucodediv"><div class="cinn">','<div class="vs1 cinner" style="display:none;"> <p>{###verifyNotice###}</p> <div class="cframe"><div class="cfl"></div> <div class="cfm">{###verifyTitle###}{###verifyCode###}</div><div class="cfr"></div></div></div>','<div class="vs2 cinner" style="display:none;"> <p>{###revVerifyNotice###}</p> <div class="cframe"> <div class="cfl"></div> <div class="cfm">{###revVerifyTitle###}</div> <div class="cfr"></div></div></div>',"</div></div></div></div>",'<img id="pview" width="104" style="display:none;position:absolute;left:39px;" />'].join(""),errorTmpl:'<article class="inner"> <span class="t2"></span> <p class="t2">{###message###}</p> <a href="javascript:void(0)" class="err_sub">重新加载</a> </article>',applyTmpl:'<a href="javascript:void(0)">立即获取</a>',backIndexTmpl:'<a href="javascript:void(0)">返回列表</a>',backPrivDetailTmpl:'<a href="javascript:void(0)">返回特权详情</a>',getCodeTmpl:'<a href="javascript:void(0)">立即使用</a>',codeTmpl:'<div class="back"><div class="wrapper ucodediv"><div style="margin-bottom:10px"><p>展示此页即可使用特权</p><div class="cframe"><div class="cfm">SN码:<span class="code"></span></div></div><div class="consume"><input name="consume_password" id="consume_password" placeholder="商家兑奖密码"/><input name="consume_money" id="consume_money" placeholder="消费金额"/><button id="check_cp">商家提交</button><br/><span>(商家输入兑奖密码可以在手机上直接使用SN码)</span></div></div></div></div>'},z={RouteCommand:function(a){H=a||(new MURLHash);var d=H.get("act"),b=null,c=0;console.log("RouteCommand",H.get("act"));if(!d){console.log("采用默认动作 act=PAGE_MEMBERCARD_1");d=WAPP.PAGE_MEMBERCARD_1}d=d+"";if(d.indexOf("PAGE_")>-1){d=WAPP[d]}else{d=d*1}switch(d){case WAPP.PAGE_MEMBERCARD_1:case WAPP.PAGE_MEMBERCARD_2:case WAPP.PAGE_SHOPCARD_1:case WAPP.PAGE_SHOPCARD_2:default:b=w.ajax_getCard;c=0;break;case WAPP.PAGE_POWER_1:b=w.ajax_getPower;c=1;break}_forEach(H.keys(),function(g,i,e){b.set(g,H.get(g))});J.ajax(b,function(e){if(e.issuccess==1){if(c==0){z.PreCardCommand(e)}if(c==1){z.PowerDetailCommand(e)}}else{z.ErrorCommand(e)}})},PreCardCommand:function(a){if(a.hasOwnProperty("isCrmShop")&&a.isCrmShop){return}if(a.hasOwnProperty("redirectUrl")&&a.redirectUrl){return A.location.href=a.redirectUrl}if(a.hasOwnProperty("cardType")){MCache.set("carddata",a)}if(a.cardType==0){z.CardCommand(a)}else{if(a.cardType==1){z.CardCommand(a)}}},CheckPowerIsOverCommand:function(b,d){if(!b.hasOwnProperty("powerIsOver")){console.log("特权未结束");return false}console.log("特权已结束");var a=document.createElement("div");var c=v.powerIsOverTmpl;c=J.parseTmpl(c,b);a.innerHTML=c;x.appendChild(a);_hide.apply(null,d);_show(_q("#card_ctn .front .fc .n"));return true},CardCommand:function(e){if(true==e.frozen){alert("您的会员卡已经被冻结！");return}if("invalid"==e.message){alert("此会员卡已经不存在！");return}J.clearStage();var aq=(e.cardType*1==1),Z="";console.log(aq?"商家版":"普通版");Z=aq?v.shopCardTmpl:v.memberCardTmpl;Z=J.parseTmpl(Z,e);J.addToStage(Z);if(e.cardlogoimg==""){_hide(_q("#cardlogoimg"))}var i=_q("#card_ctn"),ab=_qAll(".vs1"),ad=_qAll(".vs2"),a=_q("#card_ctn .vs1 h1"),d=_q("#card_ctn .vs2 h1"),n=_q("#shop_icons"),ak=_q("#shop_lst"),am=_q("#guest"),ao=_q("#vip"),r=_q("#guest ul"),s=_q("#vip ul"),ac=_q("#footBtn"),Y=_q("#card_ctn .front .fc .n"),p=_q("#card_ctn .fg"),al=_q("#card_ctn .fg img:nth-child(2)");if(e.hasOwnProperty("cardreturnbg")){J.drawCardReturnTag()}if(e.hasOwnProperty("isbarcode")&&e.isbarcode*1==1){al.src=MData(al,"src");if(al){_show(al)}_addClass(p,"barcode")}else{_removeClass(p,"barcode");if(al){_hide(al)}}var aa=aq?[_q("#"+x.id+">.vs1"),_q("#"+x.id+">.vs2"),_q("#"+x.id+">footer")]:[am,ao];if(z.CheckPowerIsOverCommand(e,aa)){aa=null;return}if(!e.hasOwnProperty("desc2")&&d){_hide(d)}if(!aq){function ae(c){switch(c){case 1:J.setCurrPage(WAPP.PAGE_MEMBERCARD_2);console.log("to WAPP.PAGE_MEMBERCARD_2",WAPP.PAGE_MEMBERCARD_2);_hide(am);_show(ao,Y);break;case 0:default:J.setCurrPage(WAPP.PAGE_MEMBERCARD_1);console.log("to WAPP.PAGE_MEMBERCARD_1",WAPP.PAGE_MEMBERCARD_1);_show(am);_hide(ao,Y);break}J.pageChg()}_forEach(e.list,function(K,L,M){var c=document.createElement("li");c.innerHTML="<b>"+K.name+"</b>";r.appendChild(c)});_forEach(e.list,function(c,M,N){var L=document.createElement("li"),K="<a";if(!c.hasOwnProperty("link")){MData(L,"ajaxParams",JSON.stringify(c.ajaxParams));MData(L,"ajaxAct",WAPP.PAGE_POWER_1);J.listenEvt(L,"click",B.commonAjaxClick)}else{K+=' href="'+c.link+'" data-link="1"'}K+=">";K+="<b>"+c.name+"</b>";if(c.hasOwnProperty("tag")&&c.tag){K+='<span class="tag t'+c.tag+'"><img alt="'+c.tagText+'" src="'+c.tagImg+'" width="'+c.tagImgWidth+'" /></span>'}K+="</a>";L.innerHTML=K;s.appendChild(L)});J.parseRoundUL();if(e.ismember==0){I.memberPageHandler=function(c){if(c.issuccess){Y.innerHTML=c.cardNum;ae(1)}else{}};function j(){w.callback_becomeMember.call(null,e.becomeMemberCallbackParams)}J.listenEvt(ac,"click",j)}A.setTimeout(function(){ae(e.ismember)},0)}else{function g(c){switch(c){case 1:J.setCurrPage(WAPP.PAGE_SHOPCARD_2);console.log("to WAPP.PAGE_SHOPCARD_2");_hide(ab);_show(ad,Y);o();i.className="cc_shop2";break;case 0:default:J.setCurrPage(WAPP.PAGE_SHOPCARD_1);console.log("to WAPP.PAGE_SHOPCARD_1");_show(ab);_hide(ad,Y);i.className="cc_shop";break}J.pageChg()}if(e.hasOwnProperty("special_update")){var af="";_forEach(e.special_update,function(c){if(c.hasOwnProperty("title")){af+='<h1 class="updateTitle" style="background-image: url(&quot;'+c.title.bgURL+"&quot;); background-position: "+c.title.bgPosi+"; -webkit-background-size: "+c.title.bgSize+"; background-size: "+c.title.bgSize+'; background-repeat: no-repeat;">'+c.title.label+"</h1>"}af+='<ul class="round updateLst">';_forEach(c.list,function(K){if(!K.hasOwnProperty("link")){af+="<li>"+K.name+"</li>"}else{af+='<li><a href="'+K.link+'" target="_self">'+K.name+"</a></li>"}});af+="</ul>"});ak.insertAdjacentHTML("afterBegin",af)}if("special_barcode" in e){var an=e.special_barcode,k=['<div class="updateBarcode" style="background-image: url(&quot;'+an.bgURL+"&quot;);","-webkit-background-size: ",an.bgSize,"; background-size: ",an.bgSize,';">','<img src="',an.img,'" />',"</div>"].join("");ak.insertAdjacentHTML("afterBegin",k)}if(e.hasOwnProperty("collection")){function m(L){var K=e.collection[L],c=document.createElement("li");c.style.backgroundImage="url("+K.bgURL+")";c.style.backgroundPosition=K.bgPosi1;c.style.webkitBackgroundSize=K.bgSize1;c.style.backgroundSize=K.bgSize1;c.style.backgroundRepeat="no-repeat";c.innerHTML="<em>"+K.list.length+"</em>"+K["short"];n.appendChild(c)}function ap(Q){var U=e.collection[Q],at=document.createElement("article"),S=U.list.length,K=v.shopLstTmpl,O=e.hasOwnProperty("showlistfull")&&(e.showlistfull*1==1);K=J.parseTmpl(K,U);at.className="shoptype";at.id="type"+Q;at.innerHTML=K;ak.appendChild(at);var T=_q("#"+at.id+" ul"),W=_q("#"+at.id+" .lst"),P=_q("#"+at.id+" h1");T.id="lstname"+Q;for(var V=0;V<S;V++){var R=document.createElement("li"),N=U.list[V],c="<a";if(!N.hasOwnProperty("link")){MData(R,"ajaxParams",JSON.stringify(N.ajaxParams));MData(R,"ajaxAct",WAPP.PAGE_POWER_1);J.listenEvt(R,"click",B.commonAjaxClick)}else{c+=' href="'+N.link+'" data-link="1"';(function(au){J.listenEvt(R,"click",function(){location.href=au})})(N.link)}c+=">";c+="<em>"+N.name+"</em>";if(N.hasOwnProperty("tag")&&N.tag){c+='<span class="tag t'+N.tag+'"><img alt="'+N.tagText+'" src="'+N.tagImg+'" width="'+N.tagImgWidth+'" /></span>'}c+="</a>";R.innerHTML=c;if(V>1){R.className="r";if(!O){_hide(R)}}T.appendChild(R)}if(S>10){var L=document.createElement("a");L.className="turn on";L.innerHTML=e.expandNotice.replace("_length_",S);MData(L,"scrollFlag","lstname"+Q);W.appendChild(L);var M=document.createElement("a");M.className="turn off";M.innerHTML=e.shrinkNotice;MData(M,"scrollFlag","lstname"+Q);W.appendChild(M);if(!O){_hide(M)}else{_hide(L)}}}for(var l=1;l<=e.collection.length;l++){if(l<=e.collectionTopNum*1){m(l-1)}ap(l-1)}sign=e.sign;if(e.cardNum==""){var ah=document.createElement("div");ah.innerHTML=v.applyTmpl;ah.id="applyBtn";ah.className="footFix";_q("body").appendChild(ah);addBodyPadding();J.listenEvt(_q("#applyBtn"),"click",function(){J.ajax({method:"POST",url:"/mobile/mc",params:{sign:sign,action:"getInfo"}},function(K){if(K.success){if(K.username!=""&&_q("#user_name").value==""){_q("#user_name").value=K.username}if(K.tel!=""&&_q("#phone").value==""){_q("#phone").value=K.tel}}});var c="<table><tr><td>姓名:<span class='error' id='error_name'></span></td></tr><tr><td><input name='user_name' id='user_name'/></td></tr><tr><td>手机号码:<span class='error' id='error_phone'></span></td></tr><tr><td><input name='phone' id='phone'/></td></tr></table>";_upShowConfirm("modal_popup_apply","会员卡申请",c,"获取",function(){if(ag()){J.ajax({method:"POST",url:"/mobile/mc/apply.jsp",params:{sign:sign,uname:encodeURIComponent(_q("#user_name").value),phone:_q("#phone").value}},function(M){_upCloseConfirm("popup_apply");if(w.callback_loadingOff){w.callback_loadingOff.call(null)}var L,K=M.result.card_num;if(M.result.success){L="<table><tr><td style='text-align:left'>您的会员卡号为:</td></tr><tr><td>"+K+"</td></tr></table>";_q(".fc .n").innerText=K;_hide(_q("#applyBtn"));_isMember=true;_forEach(_qAll(".lst li"),function(O,P,N){MData(O,"ajaxParams",MData(O,"ajaxParams").replace('"is":false','"is":true'))});clearBodyPadding()}else{L="<table><tr><td>出错了，亲，重新试试吧！</td></tr></table>"}_upShowConfirm("modal_apply_result","会员卡申请结果",L,"确定",function(){location.reload()},"",null);_addClass(_q("#modal_apply_result .cancel"),"un-visible");setPopupMiddle("#modal_apply_result");showMemberTip(M.result.shopname)},false)}},"取消",null);freshPopup();J.listenEvt(window,"resize",function(){freshPopup()})})}else{showMemberTip(e.shopname);_isMember=true;clearBodyPadding();var ar=document.createElement("div");ar.className="signarea";var aj="<div class='signwrapper'><div class='total-point'><span>我的积分</span><br/><span class='total'>"+e.point+"</span></div>";if(!e.hasSignin){var b=e.openSignin?"":"close",ai=e.openSignin?e.signPoint:"已关闭";aj+="<div class='signin "+b+"'><img src='http://wxj.weixinjia.net/image/mobile/mc/sign.png' /><div><span>签到奖励</span><br/><span>"+ai+"</span></div>"}else{ar.className+=" signed";aj+="<div class='sign-date'><span>连续签到</span><br/><span>"+e.signinDays+"天</span></div><div class='last-point'><span>签到奖励</span><br/><span>"+e.lastSigninPoint+"</span></div>"}aj+="</div>";ar.innerHTML=aj;_q("#mappContainer").insertBefore(ar,_q("#shop_lst"));if(!e.hasSignin&&e.openSignin){_q(".signin").onclick=function(){J.ajax({method:"POST",url:"/mobile/mc?action=signin",params:{sign:sign}},function(M){if(M.success){_hide(_q(".signin"));_addClass(_q(".signarea"),"signed");var N=document.createElement("div");var K="<div class='sign-date'><span>连续签到</span><br/><span>"+M.signinDays+"天</span></div><div class='last-point'><span>签到奖励</span><br/><span>"+M.point+"</span></div>";N.innerHTML=K;_q(".signwrapper").appendChild(N);var L=_q(".total-point .total");L.innerHTML=(parseInt(L.innerHTML)+parseInt(M.point))}else{alert("网络连接超时，请稍候再试。")}})}}}if("hidden"!=e.agent&&!_q("#footer")){var X=document.createElement("article");X.id="footer";X.innerHTML=e.footerTmpl;_q("body").appendChild(X)}if(_q("#cardlogoimg")){_q("#cardlogoimg").onload=function(){_q("#cardlogoimg").style["margin-top"]=(_q(".card").scrollHeight-_q("#cardlogoimg").scrollHeight)/2+"px"}}}if(e.hasOwnProperty("descAjaxParams")){function q(c){c.innerHTML='<a href="javascript:void(0)">'+c.innerHTML+"</a>";MData(c,"ajaxParams",JSON.stringify(e.descAjaxParams));MData(c,"ajaxAct",WAPP.PAGE_POWER_1);J.listenEvt(c,"click",B.commonAjaxClick)}q(a);q(d)}if(e.ismember==0){I.shopPageHandler=function(c){if(c.issuccess){Y.innerHTML=c.cardNum;g(1)}else{}};function j(){w.callback_becomeMember.call(null,e.becomeMemberCallbackParams)}J.listenEvt(ac,"click",j)}function ag(){var L=_q("#modal_popup_apply input[name=user_name]").value,K=_q("#modal_popup_apply input[name=phone]").value,c=_q("#error_name"),M=_q("#error_phone");c.innerText=L==""?"请输入您的大名":"";if(L!=""&&L.length>15){c.innerText="名字最多15个字符"}M.innerText=K==""?"请输入手机号码":"";if(K!=""&&!/^[0-9]{8,20}$/.test(K)){M.innerText="格式有误"}return c.innerText==""&&M.innerText==""}function o(){_forEach(_qAll("article"),function(N,P,R){var c=_q("#"+N.id+" .turn.on"),O=_q("#"+N.id+" .turn.off"),L=_qAll("#"+N.id+" li.r"),K=function(T){var U=MData(T.currentTarget,"scrollFlag");_q("body").scrollTop=-(F.getClientRects()[0].top-_q("#"+U).getClientRects()[0].top)},S=function(T){Array.prototype.forEach.call(L,function(V,W,U){V.style.display=T?"":"none"})},M=function(T){T.preventDefault();_hide(c);_show(O);S(true);K(T)},Q=function(T){T.preventDefault();_show(c);_hide(O);S(false);K(T)};if(c&&!MData(c,"clkbinded")){J.listenEvt(c,"click",M);MData(c,"clkbinded",1)}if(O&&!MData(O,"clkbinded")){J.listenEvt(O,"click",Q);MData(O,"clkbinded",1)}})}A.setTimeout(function(){g(e.ismember)},0)}J.confirmTel()},PowerDetailCommand:function(a){_isMember=a.is;J.setCurrPage(WAPP.PAGE_POWER_1);J.clearStage();var j=v.powerTmpl;j=J.parseTmpl(j,a);J.addToStage(j);F.id="powerPage";var d=_q("#footBtn");btn=_q("#footBtn a"),subdiv=_q("#pwr_footFrm"),chk=_q("#pwr_footFrm input[type=text]"),sub=_q("#pwr_footFrm input[type=submit]"),dtl=_q(".use_hd a.detail"),notice=_q(".asd1"),tel=_q(".asd2"),code=_q("#use_code"),cv1=_q("#use_code .vs1"),cv2=_q("#use_code .vs2"),h=_q(".use_hd"),f=_q("footer"),hdet=_q(".use_hd a.detail"),hinr=_q(".use_hd h1"),pv=_q("#pview");if(a.hasOwnProperty("notice")){var e=document.createElement("b"),c=document.createElement("ul");notice.appendChild(e);notice.appendChild(c);e.innerHTML=a.notice.title;_forEach(a.notice.list,function(m,o,p){var n=document.createElement("li");c.appendChild(n);n.innerHTML=m})}document.body.style.height="500px";setTimeout(function(){document.body.style.height="auto"},100);if(_isOldAndroid23){_addClass(code,"old")}if(a.isReverse*1){_show(subdiv,cv2);_addClass(code,"rev");function b(){var m=w.ajax_reversePower;if(a.hasOwnProperty("ajaxParams")){for(var n in a.ajaxParams){m.set(n,a.ajaxParams[n])}}m.set("checkcode",chk.value);J.ajax(m,function(o){if(o.issuccess==1){z.PowerUseCommand(o)}else{z.ErrorCommand(o)}})}J.listenEvt(sub,"click",b)}else{function k(o){_upCloseConfirm(o);var m=w.ajax_usePower;if(a.hasOwnProperty("ajaxParams")){for(var n in a.ajaxParams){m.set(n,a.ajaxParams[n])}}J.ajax(m,function(p){if(p.issuccess==1){z.PowerUseCommand(p)}else{z.ErrorCommand(p)}})}function l(m){if(_q("#modal_popup1")){return}if(a.hasOwnProperty("confirm")){_upShowConfirm("popup1","提示",a.confirm,"使用",k,"取消",null)}else{k("popup1")}}}sign=a.sign;if(_isMember){if(!_q("#codeBtn")){var i=document.createElement("div");i.innerHTML=v.getCodeTmpl;i.id="codeBtn";i.className="footFix";_q("body").appendChild(i);i.onclick=function(){_showLoading();J.ajax({method:"POST",url:"/mobile/mc/verify_code.jsp",params:{sign:sign}},function(o){if(o.success){_hide(_q(".use_note"));_hide(_q("#backIndexBtn"));_hide(_q("#codeBtn"));if(!_q("#verify_code")){var m=document.createElement("div");m.innerHTML=v.codeTmpl;m.id="verify_code";m.className="pw_xflip";_q("#mappContainer").appendChild(m);_q("#check_cp").onclick=function(){var q=_q("#consume_password").value,p=_q("#consume_money").value;if(q==""){showAlert("信息提示","请输入商家兑奖密码！")}else{if(p!=""&&!/^\d+(\.\d+)?$/.test(p)){showAlert("信息提示","请输入合法的消费金额。")}else{J.ajax({method:"POST",url:"/mobile/mc",params:{sign:sign,cp:q,price:p,vcode:_q("#verify_code .code").innerText,action:"use_code"}},function(s){var r=s.error;if(s.success){showAlert("商家验证结果","SN码使用成功！");_hide(_q("#verify_code .consume"));_q("#verify_code .cfm").innerHTML=(_q("#verify_code .cfm").innerHTML+"<span style='color:red'>(已使用)</span>")}else{if(r=="used"){showAlert("商家验证结果","使用失败！SN码已经被使用过！")}else{if(r=="invalid"){showAlert("商家验证结果","商家兑奖密码不合法！")}else{if(r=="notfound"){showAlert("信息提示","您可能已经升级为其它会员了，请重发关键词。")}else{showAlert("商家验证结果","SN码使用出错！")}}}}})}}};_hide(_q("#codeBtn"))}else{_show(_q("#verify_code"));_show(_q("#verify_code .consume"));_q("#consume_password").value="";_q("#consume_money").value=""}_q("#verify_code .cfm").innerHTML="SN码:<span class='code'>"+o.result.vcode+"</span>";if(!_q("#backPrivDetailBtn")){var n=document.createElement("div");n.innerHTML=v.backPrivDetailTmpl;n.id="backPrivDetailBtn";n.className="footFix";n.onclick=function(){_hide(_q("#backPrivDetailBtn"));_hide(_q("#verify_code"));_show(_q(".use_note"));_show(_q("#backIndexBtn"));_show(_q("#codeBtn"))};_q("body").appendChild(n)}else{_show(_q("#backPrivDetailBtn"))}_show(_q("#verify_code"))}else{if(o.result.overCount){showAlert("温馨提醒","使用次数已达最大上限！")}}},false)}}else{_show(_q("#codeBtn"))}}if(!_q("#backIndexBtn")){var g=document.createElement("div");g.innerHTML=v.backIndexTmpl;g.id="backIndexBtn";g.className="footFix";g.onclick=function(){history.back()};_q("body").appendChild(g)}else{_show(_q("#backIndexBtn"))}if(_isMember){_q("#codeBtn").style.width="50%";_q("#backIndexBtn").style.width="50%";_q("#backIndexBtn").style.left="50%"}else{_q("#backIndexBtn").style.width="100%";_q("#backIndexBtn").style.left="0"}pid=a.pid;addBodyPadding();J.pageChg()},PowerUseCommand:function(b){var d=_q("#footBtn");btn=_q("#footBtn a"),subdiv=_q("#pwr_footFrm"),sub=_q("#pwr_footFrm input[type=submit]"),dtl=_q(".use_hd a.detail"),notice=_q(".asd1"),tel=_q(".asd2"),code=_q("#use_code"),h=_q(".use_hd"),f=_q("footer"),hdet=_q(".use_hd a.detail"),hinr=_q(".use_hd h1"),pv=_q("#pview");pv.src=w.imgpath+"power_view.png";function a(){pv.style.top="auto";pv.style.bottom=-F.scrollTop+"px"}function c(){J.setCurrPage(WAPP.PAGE_POWER_2);_hide(d,subdiv,notice,tel,f);_show(code,hdet,pv);_addClass(F,"s1");_addClass(h,"s1");setTimeout(function(){_addClass(code,"flip")},100);J.listenEvt(A,"scroll",a);J.pageChg()}code.innerHTML=J.parseTmpl(code.innerHTML,b);c();A.addEventListener("touchmove",a);A.addEventListener("touchend",a);if(hinr.clientHeight<=60){_hide(dtl)}else{hinr.style.height="60px";if(!MData(dtl,"clkbinded")){function e(g){hinr.style.height="auto";_hide(dtl);a()}J.listenEvt(dtl,"click",e);MData(dtl,"clkbinded",1)}}},ErrorCommand:function(a){if(a.alertWhenError){return}J.clearStage();var c=v.errorTmpl;c=J.parseTmpl(c,a);J.addToStage(c);F.id="errPage";var b=_q(".err_sub");function d(){location.reload()}J.listenEvt(b,"click",d)}},y=function(){x=document.createElement("div");x.id="mappContainer";F=_q("body");F.appendChild(x);H=new MURLHash();if(!H.toString().length){location.hash="act=1"}J.bindHashListener();z.RouteCommand()},D={startup:y,modals:G,views:v,controllers:z};return{facade:D,utils:{ajax:J.ajax},config:function(a){w=a},getConfigItem:function(a){return w[a]},getCurrPage:function(){return t},getHandler:function(a){return I[a]}}}(window,undefined));WAPP.PAGE_MEMBERCARD_1=1;WAPP.PAGE_MEMBERCARD_2=2;WAPP.PAGE_SHOPCARD_1=3;WAPP.PAGE_SHOPCARD_2=4;WAPP.PAGE_POWER_1=5;WAPP.PAGE_POWER_2=6;function _report(e,g){var d=[e,g,qrcode,sid,user_wxid];ajax("/wsh/report?p="+d.join(),function(a){})}function ajax(url,func){var request=false;request=new XMLHttpRequest();request.open("GET",url,true);request.onreadystatechange=function(){if(request.readyState==4&&request.status==200){var response=eval("("+request.responseText+")");func(response)}};request.send(null)}function shareFriend(){WeixinJSBridge.invoke("sendAppMessage",{appid:window.shareData.appid,img_url:window.shareData.imgUrl,img_width:"640",img_height:"640",link:window.shareData.sendFriendLink,desc:window.shareData.tContent,title:window.shareData.tTitle},function(b){_report("send_msg",b.err_msg)})}function shareTimeline(){WeixinJSBridge.invoke("shareTimeline",{img_url:window.shareData.imgUrl,img_width:"640",img_height:"640",link:window.shareData.timeLineLink,desc:window.shareData.tContent,title:window.shareData.tTitle},function(b){_report("timeline",b.err_msg)})}function shareWeibo(){WeixinJSBridge.invoke("shareWeibo",{content:window.shareData.wContent,url:"http://meishi.qq.com/weixin",},function(b){_report("weibo",b.err_msg)})}function freshPopup(){if(!_q("#modal_popup_apply")){return}_q("#modal_modal_popup_apply").style["min-height"]=window.innerHeight+"px";var a=window.innerHeight,c=window.scrollY,d=_q(".pinner").offsetHeight,b="";if(a<=d){var e=document.activeElement;if(e.id=="user_name"){b=(a-_q("#user_name").offsetHeight)/2+c-80+"px"}else{if(e.id=="phone"){b=(a-_q("#phone").offsetHeight)/2+c-140+"px"}}}else{b=(a-d)/2+c+"px"}if(b){_q(".pinner").style["margin-top"]=b}}function setPopupMiddle(a){_q(a).style["margin-top"]=(window.innerHeight-_q(".pinner").offsetHeight)/2+window.scrollY+"px"}function showMemberTip(a){var b=document.createElement("h1");b.style.color="red";b.style["margin-top"]="22px";b.style["margin-bottom"]="0px";b.innerText="您已经成为【"+a+"】的尊享会员";_q("#shop_lst .shoptype").appendChild(b)}function addBodyPadding(){_q("body").style["padding-bottom"]="50px"}function clearBodyPadding(){_q("body").style["padding-bottom"]="0px"}function showAlert(b,a){b=b||"";a=a||"";_upShowConfirm("modal_popup_alert",b,a,"确定",null,"",null);_addClass(_q("#modal_popup_alert .cancel"),"un-visible");setPopupMiddle("#modal_popup_alert")};